title: SMP2018对话机器人任务构建
type: post
date: 2018-12-29 09:20:45
category: 
---


# SMP2018对话机器人任务构建

## 0. SMP ECDT 2018

-  特定领域包括:机票类、火车票类、酒店类3个垂直领域,系统通过与测试
人员实时在线对话完成相应的预定或查询任务。
- 本届中文人机对话技术评测由中国中文信息学会社会媒体处理专委会主
办,哈尔滨工业大学、科大讯飞股份有限公司承办,讯飞公司提供数据,
华为公司提供奖金。旨在促进中文人机对话系统相关研究的发展,为人
机对话技术相关的学术研究人员和产业界从业人员提供一个良好的沟通
平台。

## 1. 需求分析

### 1.1. 基本比赛需求分析

比赛的机器人要求能实现订票功能，一共三种功能：

- 飞机票预订
- 火车票预订
- 酒店预订

提供的示例很少，只包括开始的例句和四段对话流程分析，整个对话任务需要大量人工数据介入。

首先的几个例句：

1. 你好啊，很高兴见到你！ — 闲聊类
2. 我想订一张去北京的机票。 — 任务型垂类（订机票）
3. 我想找一家五道口附近便宜干净的快捷酒店 — 任务型垂类（订酒店）

其次有几个官方提示：

- 认真考虑一句意图存在连续的若干意图，如"帮我预定一张从北京出发到重庆的4月18号的机票，再预定重庆到成都的火车票一张，再预定成都的向日葵酒店公寓一晚。"此类意图在评分过程中占有更大的分数比例。
- 认真考虑资源库外的属性、属性值的判定情况，例如，假设资源库中没有的属性WI-FI，但测试人员询问"有没有wifi提供？"；假设资源库只覆盖未来10天的机票信息，但测试人员订一个月以后的票。

http://smp2018.cips-smp.org/ecdt_index.html

### 1.2. 任务示例

#### 1.2.1 任务型对话示例1：

用户完整意图：预定下周四（2018年4月12日）从北京去上海的上午或者中午出发，价格低于8折的便宜机票。

- U：下周从北京去上海
- R：请问您需要订票吗？
- U：恩，是的
- R：请问您要下周哪天出发呢？
- U：周四吧
- R：帮您预订2018年04月12日从北京到上海的机票，请问有餐饮，价格等其他的要求吗？
- U：尽量订上午的吧，价格找便宜一点的
- R：帮您查询了2018年04月12日从北京到上海的机票，没有上午出发的航班，中午12：10出发是否可以？7.3折，910元
- U：也行，就订这个吧
- R：即将帮您预订2018年04月12日从北京到上海的机票，南方航空，CZ6412 空客321（中），12：10：00出发，7.3折，910元，不可退改签，确定要订票吗？
- U：是的
- R：已经帮您预订该航班机票，将跳转至付款页面

#### 1.2.2 任务型对话示例2：

用户完整意图：预定明天（2018年4月10日），丽江古城区附近的一家酒店，价格不超过200元每晚。

- U：我想预定丽江古城区附近的酒店
- R：请问您想哪天入住呢？
- U：明天吧
- R：请问您对价格有要求吗？
- U：别太贵，每晚200元以下吧
- R：2018年04月10日入住，丽江古城区附近，价格200元以下的酒店，为您找到以下结果（与用户意图最相关的5个酒店结果），请问您想预定哪一个？
- U：就这个丽江古城联强酒店吧
- R：好的，已经帮您预订丽江古城联强酒店，2018年04月10日入住。

#### 1.2.3 任务型对话示例3：

用户完整意图：查询明天（2018年4月10日）从哈尔滨到北京的晚间软卧火车票信息，上下铺均可。

- U：到北京的软卧火车票还有吗？
- R：请问您要从哪里出发？
- U：哈尔滨
- R：您要定哪天的呢？
- U：明天吧
- R：请问您对发车时间有要求吗？
- U：晚上的，正好能睡一觉
- R：请问您要上铺还是下铺呢？
- U：都行
- R：您要查询的2018年04月10日 晚间出发从哈尔滨到北京的软卧火车票信息如下（与用户意图最相关的5个火车票查询结果）

#### 1.2.4. 任务型对话示例4：

用户完整意图：预定2018年4月10日从哈尔滨到北京的上午的航班或火车，价格低于500元，同时预定2018年4月10日五道口附近300-400元的快捷酒店一晚。

- U：查一下明天从哈尔滨到北京的机票
- R：请问您要什么舱位？
- U：经济舱
- R：您要上午，下午，晚上哪个时间段出发？
- U：上午吧
- R：有一个上午6：25出发的南方航空CZ6421的航班，5.8折，不含税价720，请问您要预订此航班机票吗？
- U：有点贵啊，不订机票了，看看火车票吧
- R：2018年4月10日从哈尔滨到北京，上午的火车车次信息如下（与用户意图最相关的5条火车车次信息），请问您要预定哪一个车次？几等座？
- U：D26，二等座吧
- R：即将帮您预定2018年4月10日从哈尔滨到北京，D26次列车二等座。
- U: 好的，再帮我找找北京五道口附近的快捷酒店吧
- R：请问您哪天入住？住几晚？
- U：明天入住，一晚。
- R：请问您对房间价格有要求吗？
- U：别超过400元一晚
- R：以下是2018年4月10日入住，五道口附近的快捷酒店信息（与用户意图最相关的5个快捷酒店信息），请问您想预定哪一个？
- U：第一个吧
- R：即将预定2018年4月10日入住一晚，五道口附近，汉庭酒店（清华东门店）标准间一间，每晚377元，请问您认要预定吗？
- U：确认
- R：已经帮您预订该酒店，将跳转至付款页面


1.3. 分析结果

- 事实：
    - 例句非常少
    - 对于系统能力与边界不够明确
    - 如何测试和评测具体目标不够明确

- 动作：
    - 需要人工收集对话内容、泛化
    - 需要定义需要的要素和意图
    - 以官方样例为模板能实现相近结果

## 2. 功能设计

### 2.1. 要素整理

按照官方示例整理要素，例如：

- 一晚
- 第一个
- 明天
- 上午
- 别超过400元
- 丽江古城区附近

这些需要分门别类整理成不同种类的要素。

有些要素可以认为是有限要素，例如城市、一晚、上午。相对容易处理，因为可能只要枚举有限数量的词汇表就可以达到目的。

有些要素可以认为是无限要素，例如“丽江古城区附近”。相对处理困难。因为描述地点的短句和句子可以非常多，并且组合形式也很多。

### 2.2. 对话流程设计

**仅供参考的流程，并不是全真的**

#### 领域整理

- 旅行
  - 飞机
  - 火车
- 酒店

把飞机和火车合并为一个旅行的领域是因为需要在飞机和火车中间进行更方便的切换，例如完成：“我还是不做飞机了，做火车吧”这种需求

#### 意图整理

用户意图分类举例

- 用户提供信息
  - 我要去北京
  - 古城区附近
- 用户选择
  - 第一个
  - 随便
- 用户提问
  - 几点到
  - 多少钱
- 其他
  - 谢谢
  - 再见

系统意图分类举例

- 向用户提供信息
  - 票价xx元
  - 车20:00开
- 提供选择
  - 酒店列表
  - 飞机、火车列表
- 向用户提问
  - 从哪出发
  - 几点出发
- 其他
  - 谢谢
  - 再见

流程举例

1. 旅行  
    1. 旅行购票
    2. 购票
    3. 询问目的地
    4. 询问出发地
    5. 询问出发时间
    6. 询问其他需求（筛选）
        1. 舱位类型
        2. 车票车厢类型
        3. 价格范围
    7. 推荐票（返回列表）
    8. 用户提问
        1. 询问价格
        2. 询问行程
        3. 询问时间
        4. 未知询问（无法回答的问题）
    9. 购票确认
2. 酒店
    1. 预订地点
    2. 询问其他需求
        1. 价格范围
        2. 住几晚
    3. 推荐酒店（返回列表）
    4. 用户提问
        1. 询问价格
        2. 询问地点
        3. 询问电话
        4. 未知询问（无法回答的问题）
    5. 预订酒店确认

### 2.3. 需要注意的地方

1. 各个用户输入的要素需要能叠加，例如用户可以同时提供“价格范围”和“住几晚”这样的信息

也就是用户的一句话提问可以有任意多的信息要素，每个要素的顺序实际上是会影响抽取效果的，所以在准备数据的时候要注意这一点。

例如我们如果有一份数据是：

- 我要在北京住一晚
- 我要住一晚在北京

他们本质上是一样的，但是基于统计的NER可能会因为样例缺失导致泛化能力不够

2. 在火车和机票之间能切换

例如：还是不订火车了，看看飞机票吧
 
火车票和机票之间很多要素需要能通用，例如出发城市、目的地城市、出发日期等。但是也要有不同的要素，例如飞机舱位、火车座位类型等等。

相同的要素需要能转移与继承，但是不同的要素要能准确的重置

3. 意图之间要随时挂起与恢复，例如：还是先不订票了，我先订酒店吧

需要能暂停当前的任务状态，但是这个状态并不是被取消，而是被挂起。

完成新的任务之后需要能恢复之前的任务，实现时会询问是否恢复之前的任务，可以有任意多的任务挂起并压栈，完成当前任务后如果任务栈中有未完成任务需要能恢复。这个部分采用类似面向对象的设计方法，每个任务在程序中都是一个示例，直到取消或完成时被销毁。

4. 要随时应对对话跳转，例如用户重新输入目的地，那时间、舱位、价格等等信息需要重新询问

在对话流中，有些要素之间是有相互关系的。例如用户选择了某个具体列车，但是又更改了目的地，那显然这个选择了的列车要取消。

5. 一句话要能应对多个意图，例如：订一张从北京到上海的机票，然后订一张从上海去杭州的高铁

在NLU的设计时就考虑了如何拆分意图的能力。

这里的设计比较简单：首先使用标点符号分割一个长意图中的每个意图，然后判断每个意图的领域，领域可以有：旅行，酒店，无领域三种选择。

例如：订一张北京去上海的机票，要明天的，然后订上海的酒店。

三句话的领域分别是：旅行，无领域，酒店。

中间的无领域“要明天的”，会跟前面有领域的意图合并，也就是本质上合并为两个意图：

- [旅行] 订一张北京去上海的机票，要明天的
- [酒店] 然后订上海的酒店。

6. 能回答用户问题：火车几点到，飞机一共飞多久

实际设计中设计了单独的问答意图，用户提到的要询问的属性也被作为要素提取出来，到数据库中匹配。

7. 要能响应无法回答的问题，例如响应闲聊，响应没有答案的问题

例如：这个火车能订麦当劳吗

这种问题我们无法回答，因为数据库没有，但是需要处理，也就是正确识别某些问题我们是无法回答的。这需要数据集的层面上有一定的处理，在流程上也有一定的处理。


### 2.4. 用户行为与系统行为

根据系统样例、在不断迭代过程中产生的最终用户行为

行为 | 描述 | 样例
---|---|---
hello | 用户问候 | 你好
unknown | 未知用户需求，默认为闲聊 | 我想听歌
inform | 最多的情况，用户提供各种信息 | 是从北京到上海
startTravel | 开始一次旅行订票，包括机票和火车票 | 我要去北京的机票
startHotel | 预订酒店开始 | 我要订北京的酒店
more | 用户查询更多信息 | 还有呢？下一页？
no | 用户否定 | 不要了
yes | 用户肯定 | 就这个吧
bye | 用户离开系统 | 再见
cancel | 用户取消 | 算了不定了
notcare | 用户不在乎某个选项（相当于某个条件设置为任意宽松） | 上午还是下午出发？“随便吧”
ask | 用户问询具体信息 | 这个票多少钱
thankyou | 用户感谢 | 谢谢
nextDay | 一些时间修改 | 后一天呢？前一天呢？

根据系统样例、在不断迭代过程中产生的最终系统行为


行为 | 描述 | 样例
---|---|---
hello | 系统问候 | 我能订票和酒店
unknown | 系统没理解用户意图的情况 | 我只能订票
changeDomain | 询问是否改变领域 | 是否暂停订票并
askTravelOrHotel | 询问意图是旅行还是订旅馆 | 用户：我要到北京；系统：订北京的酒店还是订去北京的机票？
askCabin | 询问座位类型 | 头等舱还是经济舱？
askArriveCity | 询问目的城市 | 到哪个城市去
askDepartCity | 询问出发城市 | 从哪出发
askDepartDate | 询问出发日期 | 什么时候出发
askTravelChoice | 询问旅行类型 | 火车还是飞机
askArriveDate | 询问到达日期 | 到达日期是什么时候
askNearby | 询问酒店定在哪附近 | 酒店需要在北京的哪个地方？
askNights | 询问住几晚 | 住几晚
askHotelChoice | 酒店选择 |
confirmHotel | 酒店确认 |
askPrice | 询问价格范围 |
confirmTravel | 确认旅行 |
askDepartTime | 询问出发时间 | 
askArriveTime | 询问到达时间 |
orderHotel | 订酒店 |
orderTravel | 订车票、飞机票 |
noHotel | 否定酒店选择 |
noTravel | 否定车票选择 |
bye | 系统完成订票并再见 |
noAnswer | 没有筛选出合适车票的情况 |
answer | 回答用户提问 |
askFlightCabin | 询问飞机仓位 |
askTrainCabin | 询问火车座位类型 |
noTrain | 否定当前列车选择 |
askTrainType | 询问列车类型 |
thankyou | 系统反馈感谢使用（类似bye） |

## 3. BOT组件

### 3.1. NLU

#### 3.1.1. NLU方法简介

NLU主要负责将用户输入提取出三个要素：

- Domain 领域
- Intent 意图
- Slots 要素/槽值/实体

在这里Domain/Intent识别使用的是基于Keras的LSTM分类器

Slots识别使用基于Bi-LSTM + CRF的NER/Tagger

*没有做联合Slots + Intent识别

#### 3.1.2. NLU训练数据构成

比赛中几乎没有什么数据，绝大部分数据几乎都是人工构造的

构造方法基本是：

DATA = TEMPLATE × VARIANCE × ENTITIES + ERROR

其中Template指句子模板，
Variance是其中词汇的变化
Entities是需要提取的slot的变化
Error是人为错误。

例如：

我{要订}去{北京}的{机票}

要订 = Variance in {
    需要，
    需要订，
    订购，
    ……
}

北京 = Entities in {
    北京，
    上海，
    成都，
    ……
}

Error = {
    标点符号变化（例如完全不用标点符号而用空格），
    字随机缺失，
    冗余字符（重复某个字符或额外空格），
    ……
}

#### 3.1.3. NER后续处理规则

对于NER识别出来的实体，实际上会经过一轮基于词表与规则的匹配，具体方法是：

1. 对于数字进行归一化等，例如“1”和“一”的语义是一致的。
2. 对于城市、车辆号码、飞机编号等实体，对库中有的实体进行相似度排序（基于n-gram的jaccard距离），然后根据排序结果、词汇长度得到一个分值，当这个分值大于某个阈值的时候才算正确。


#### 3.1.4. 主要问题

数据量还是不够，模板泛华能力有待提高

因为数据是构造的，分类器很容易得到高precision，但是到实际环境内可能面临的错误会比较多，例如错误的分类或错误的NER抽取。

这里的基本方案（并非完美）

- 分类器（domain/intent）
    - 在阈值上就增加precision，降低recall，只回答绝对有把握的问题，也就是说无把握的问题就重复问
- 抽取NER
    - 在实体对齐的时候严格检查，也是增加precision，降低recall

关于地址的识别准确率实在很低，因为描述一个地点的词汇量太大，变化太多。所以事实上的模型中，地点的部分识别是根据上下文（上一轮System Action），然后差不多就好。

### 3.2. DST

根据当前的上下文（Context）更新当前的任务帧（要素状态、Dialog State）

基本原则：

- 对于某些明确要素，例如“住几晚”这样比较明确的实体，遇到则填充
- 如果对于不明确的要素，例如用户输入数字“1”，那么有可能是说“住一晚”，也可能是说“选择第一个结果列表中的列车/飞机”，那么就需要根据上一轮系统发出的询问来判断
    - 如果上一轮系统在询问用户住几晚，那么就填充住1晚
    - 如果上一轮系统在询问用户选择哪个结果，那么就执行选择
    - 如果是其他情况，那么说明系统不理解当前用户输入的“1”是什么意思，那么就告诉用户当前无法继续，并重复上一次系统的问题

### 3.3. DM

DM使用微软的BotFramework框架，主要是基于瀑布流设计的规则。

主要的思想是：

1. 对话任务本质是填满任务帧（Task Frame），即填满就算完成任务。所以我们只要按照瀑布流思想顺序的填满所有任务帧中的要素（Slot）就可以了。
2. 每次对话流程都按照顺序检测一遍帧中的要素，在必填要素未填时“中断”，像用户提问。

举例来说，假设我们精简任务帧，只考虑一个最简单的火车票模型。让出发城市、目的城市出发日期成为必要填充帧。然后我们需要增加一些用来控制的帧，例如：是否确认了哪趟车（车号），是否确认了购买车票。那么完整的帧结构类似下面的情况：

1. 出发城市（是否填充）
2. 目的地城市（是否填充）
3. 出发日期（是否填充）
4. 所选择车号（是否填充）
5. 购票确认（是否填充）

假设以上内容都填充好，则相当于确认了所有必要元素，也就是说这个瀑布流任务可以被当做完成。而每回合，都会从头开始对每一项是否填充做检测。出现问题则“中断”并且向用户提问（即系统发出Request），用户回答之后（用户发出Inform），如果内容满足填充条件，则继续填充下去。

如果修改了前面的某一项，例如正在确认是否购票，但是用户改变了出发城市，那么实际上后面的目的地城市、出发日期、所选车号、购票确认都会被重置。

### 3.4. NLG

#### 3.4.1. 使用的NLG方法简介

NLG直接使用TypeScript的规则实现，每个System Action对应一个模板函数。即输入一个System Action，输出一个字符串。

对于某个函数都有0个或多个参数，而函数本身会根据不同参数来选择不同的输出。


```
// input: system action == hello(name)
// output: natural language
funciton hello (name: string= null) {
  if (name) {
    return `你好，${name}`
  }
  return '你好'
}
```


### 3.4.2. NLG Trick

1. 提示用户输入了什么，避免用户输入错误（文字Only）

显式的说出用户刚刚填充（Inform）的信息，进行下一轮提问。

例如：好的，我会帮助你选择头等舱的机票，请告诉我是否对价格有需求？

2. 系统陷入重复时，提示用户可以做什么（例如重来）

例如第一次提示：请告诉我目的地

如果连续两次没识别出用户意图的时候要提示：抱歉我还是不知道你的目的地，请告诉我你的目的地，例如：我要去北京

宁可啰嗦，也要避免不准确（人为降低Recal增加Precision）

3. 回答全部用户问题相关的答案，增加用户提问的Recall（文字Only）

用户问：这个车几点到？

您好火车000xxx从北京到上海，12点出发，18点到达，行程6小时，票价xxx元。

## 4. 经验教训

### 4.1 产品与开发

1. 所有一切都是模块（函数）。每个模块（函数）都应该可以被其他类似组件任意替代，例如NLU可以是规则的也可以是统计的，只要定义好输入输出就应该可以任意替换。

每个模块都会被自动、半自动测试。最终类似机器学习的CrossValidation总是挑选最优的模块组合。

2. 花时间构建辅助工具，提升效率
    1. NLU测试工具
    2. 句子标注工具
    3. 自动化测试工具，不断进行各种对话流程的自动化测试，并且不断添加测试用例

3. 设计可迭代的模型，在一开始限制机器人能力

机器人需要有演化能力，不能因为要素添加、删除就大量的更改流程。

这就需要每个模块，包括规则化的DM中设计好每个步骤的输入、输出、规则，尽量降低每个模块中的耦合度。

## 4.2. 结果分析

### 4.2.1. 某些未知属性、要素处理不好

- 哪个有午餐
- 五星级酒店
- 大床房
- 有wifi的旅馆
- 靠窗的火车座位
- 能提供早餐吗

关于飞机、旅馆的餐饮，酒店的wifi、房型，道理来说我们是没有数据的，但是实际上比赛要求对于没有数据的部分应该给妥善回答，具体怎么回答的话术其实没有严格固定。

例如问飞机哪个有午餐，可以回答：“我不知道哪个有午餐”，但是不能出现意图识别错误的情况。

“靠窗的”这个需求也是没考虑的，参考比赛的需求来讲应该回答：“我会尽量选择靠窗座位”，之类的回答，哪怕没有确认，但是至少表明意图识别正确。

### 4.2.2. 位置信息处理不好

- 要在山东师范大学附近

这个位置信息重复了两遍，应该是出现了识别错误，上文讲到位置信息实际上是比较难识别的信息，所以机器人在这方面做到可能并不好。

### 4.4.3. 用户问题处理不好

没有软卧吗

这个问题不能简单的理解为用户需要软卧，而是要回答“是、否”的问题，这个问题这次机器人并没有处理。
